<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
<title>똑똑!! 가족 게시판</title>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

<style type="text/scss">
/* Sass 스타일 적용 */
$bg: #f8fafc; $card: #ffffff; $line: #e5e7eb; $brand: #6366f1; $ok: #16a34a; $bad: #dc2626; $wait: #d97706;

@font-face { font-family: 'NexonLv2Gothic'; src: url('NexonLv2Gothic_2.ttf') format('truetype'); }
* { box-sizing: border-box; }
html, body { overscroll-behavior-y: none; height: 100%; }
body, button, input, textarea { margin: 0; font-family: 'NexonLv2Gothic', sans-serif; background: $bg; }

header {
    padding: 20px 16px; text-align: center; background: #fff; border-bottom: 1px solid $line;
    h1 { margin: 0; font-size: 24px; font-weight: 700; cursor: pointer; display: inline-block; }
    p { margin: 8px 0 0; font-size: 16.8px; color: #666; line-height: 1.4; }
}

main { max-width: 1100px; margin: auto; padding: 16px; }
body.full-view main { max-width: 100%; padding: 0; height: calc(100% - 60px); }
body.full-view header { border-bottom: none; }

.card { background: $card; border: 1px solid $line; border-radius: 10px; padding: 16px; margin-bottom: 16px; }

button, .sms-btn {
    display: block; width: 100%; padding: 9px 16px; border: none; border-radius: 8px; background: $brand; color: #fff; 
    font-weight: 600; cursor: pointer; margin: 6px 0; text-align: center; text-decoration: none; font-size: 16px; font-family: inherit;
    &.gray { background: #e5e7eb; color: #111; }
    &.green { background: $ok; }
    &.red { background: $bad; }
    &.fit { width: auto; min-width: 80px; display: inline-block; margin: 0 8px 0 0; padding: 9px 20px; }
    &.small { padding: 4px 10px; font-size: 13px; margin: 0; }
    /* 환경설정 아이콘 버튼 스타일 */
    &.btn-config { background: #94a3b8; width: 42px !important; padding: 8px 0 !important; font-size: 18px; margin: 0 !important; }
}

input, textarea {
    width: 100%; padding: 12px; border-radius: 8px; border: 1px solid $line; margin-top: 6px; line-height: 1.4; 
    font-size: 16px; color: #333; font-family: inherit; background: transparent;
    &:disabled { background: transparent; color: #333; border-color: #eee; }
}

label { font-weight: 600; margin-top: 14px; display: flex; align-items: center; justify-content: space-between; }
.top-actions { display: flex; gap: 8px; margin-bottom: 12px; justify-content: flex-start; align-items: center; }
.btn-submit, .btn-stats, .btn-cal { width: auto !important; margin: 0 !important; padding: 8px 18px !important; }
.btn-cal { margin-left: auto !important; background: #4b5563; }

.table-wrapper { max-height: 540px; overflow-y: auto; border: 1px solid $line; border-radius: 8px; }
table {
    width: 100%; border-collapse: collapse; position: relative; table-layout: fixed;
    thead th { position: sticky; top: 0; background: #fdfdfd; z-index: 10; border-bottom: 2px solid $line; }
    th, td { padding: 12px; border-bottom: 1px solid $line; text-align: center; vertical-align: middle; }
}

.badge { padding: 6px 10px; border-radius: 6px; color: #fff; font-size: 13px; font-weight: 700; white-space: nowrap; &.ok{background:$ok} &.no{background:$bad} &.wait{background:$wait} }
.modal { position: fixed; inset: 0; background: rgba(0,0,0,.4); display: none; align-items: center; justify-content: center; padding: 16px; z-index: 1000; }

/* 캘린더 스타일 유지 (기존과 동일) */
.cal-wrapper { background: #fff; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; position: relative; }
.cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); background: $line; gap: 1px; flex: 1; }
.cal-day { background: #fff; padding: 4px; font-size: 13.2px; cursor: pointer; display: flex; flex-direction: column; }
</style>
<script src="https://cdn.jsdelivr.net/npm/sass.js@0.11.1/dist/sass.sync.js"></script>
</head>
<body>
<header id="main-header">
    <h1 onclick="goHome()">똑똑!! 가족 게시판</h1>
    <p id="header-desc">엄마와 아빠는 언제나 너의 멋진 계획을 응원해!</p>
</header>
<main id="app">데이터 로딩 중...</main>
<div id="pwModal" class="modal"></div>
<div id="statModal" class="modal"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyC4wyLWlZSDwNN8pqMSxiebB9z5CWrc93E",
  authDomain: "family-systems-4d19c.firebaseapp.com",
  databaseURL: "https://family-systems-4d19c-default-rtdb.firebaseio.com",
  projectId: "family-systems-4d19c",
  storageBucket: "family-systems-4d19c.firebasestorage.app",
  messagingSenderId: "670976286244",
  appId: "1:670976286244:web:84ae3450cbfc6823ec82b1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// URL 파라미터에서 f 값 추출 (공간 구분용)
const urlParams = new URLSearchParams(window.location.search);
const tenantId = urlParams.get('f') || 'default';
const tenantPath = `tenants/${tenantId}`;

let config = { entryPw: "1111", masterPw: "1111", headerTitle: "똑똑!! 가족 게시판", headerDesc: "엄마와 아빠는 언제나 너의 멋진 계획을 응원해!" };
let route = { page: "list", id: null, date: null };
let keyword = "";
let allData = [];
let calendarData = {};
let currentCalDate = new Date();
let isAuthorized = localStorage.getItem(`auth_${tenantId}`) === "true";

// Firebase 설정값 로드
db.ref(`${tenantPath}/config`).on("value", (snap) => {
    if(snap.exists()) {
        config = snap.val();
        document.querySelector("header h1").innerText = config.headerTitle;
        document.getElementById("header-desc").innerText = config.headerDesc;
    }
});

db.ref("approvals").on("value", (snapshot) => {
    const val = snapshot.val();
    allData = val ? Object.keys(val).map(k => ({...val[k], dbId: k})) : [];
    if(isAuthorized && (route.page === "list" || route.page === "view")) render();
});

db.ref("calendar_v3").on("value", (snapshot) => {
    calendarData = snapshot.val() || {};
    if(isAuthorized && (route.page === 'calendar' || route.page === 'calDetail')) render();
});

window.onload = () => { if(!isAuthorized) checkEntryPassword(); else render(); }

function checkEntryPassword() {
    const m = document.getElementById("pwModal"); m.style.display = "flex";
    m.innerHTML = `<div class="card" style="text-align:center;"><b>접속 비밀번호</b><input id="entryPw" type="password" style="text-align:center; margin-top:10px;"><div class="btn-row"><button onclick="verifyEntryPw()">확인</button></div></div>`;
}

function verifyEntryPw() {
    if(document.getElementById("entryPw").value === String(config.entryPw)) {
        isAuthorized = true; localStorage.setItem(`auth_${tenantId}`, "true"); closeModal(); render();
    } else { alert("비밀번호가 일치하지 않습니다."); }
}

function render() {
    const app = document.getElementById("app");
    const header = document.getElementById("main-header");
    document.body.classList.remove("full-view");
    header.style.display = (route.page === "calendar") ? "none" : "block";

    if(route.page === "list") {
        app.innerHTML = `
            <div class="top-actions">
                <button class="btn-submit" onclick="navigate({page:'new'})">의견 올리기</button>
                <button class="btn-stats" onclick="openStats()">통계</button>
                <button class="btn-cal" onclick="navigate({page:'calendar'})">캘린더</button>
                <button class="btn-config" onclick="openConfigAuth()">⚙️</button>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead><tr><th>No</th><th>제목</th><th>상태</th></tr></thead>
                    <tbody>
                        ${allData.map((r, i) => `<tr onclick="navigate({page:'view', id:'${r.id}'})"><td>${allData.length-i}</td><td style="text-align:left;">${esc(r.title)}</td><td>${badge(getStatus(r))}</td></tr>`).join("")}
                    </tbody>
                </table>
            </div>`;
    } 
    else if(route.page === "config") {
        app.innerHTML = `
            <div class="card">
                <h3>환경설정</h3>
                <label>접속 비밀번호</label><input id="setEntry" value="${config.entryPw}">
                <label>부모 비밀번호</label><input id="setMaster" value="${config.masterPw}">
                <div class="btn-row"><button onclick="saveConfig()">저장하기</button><button class="gray" onclick="navigate({page:'list'})">취소</button></div>
            </div>`;
    }
    // 기타 페이지(new, view, calendar 등) 기존 로직 유지
}

function openConfigAuth() {
    const m = document.getElementById("pwModal"); m.style.display = "flex";
    m.innerHTML = `<div class="card" style="text-align:center;"><b>부모 인증</b><input id="confPw" type="password" style="text-align:center; margin-top:10px;"><div class="btn-row"><button onclick="verifyConfigAuth()">확인</button><button class="gray" onclick="closeModal()">취소</button></div></div>`;
}

function verifyConfigAuth() {
    if(document.getElementById("confPw").value === String(config.masterPw)) { closeModal(); navigate({page:'config'}); }
    else alert("비밀번호가 일치하지 않습니다.");
}

function saveConfig() {
    db.ref(`${tenantPath}/config`).update({ 
        entryPw: document.getElementById("setEntry").value, 
        masterPw: document.getElementById("setMaster").value 
    }).then(() => { alert("저장되었습니다."); navigate({page:'list'}); });
}

function navigate(p) { route = p; render(); }
function goHome() { navigate({page:'list'}); }
function closeModal() { document.getElementById("pwModal").style.display = "none"; }
function esc(s){ return String(s??"").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
function getStatus(r){ if(r.mom === "pending" || r.dad === "pending") return "대기"; return (r.mom === "approve" && r.dad === "approve") ? "찬성" : "반대"; }
function badge(s){ return `<span class="badge ${s==='찬성'?'ok':(s==='반대'?'no':'wait')}">${s}</span>`; }
</script>
</body>
</html>
