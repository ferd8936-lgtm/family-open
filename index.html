<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
<title>똑똑!! 가족 게시판</title>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

<style type="text/scss">
/* Sass 스타일 적용 */
$bg: #f8fafc;
$card: #ffffff;
$line: #e5e7eb;
$brand: #6366f1;
$ok: #16a34a;
$bad: #dc2626;
$wait: #d97706;

@font-face {
    font-family: 'NexonLv2Gothic';
    src: url('NexonLv2Gothic_2.ttf') format('truetype');
}

* { box-sizing: border-box; }
html, body { overscroll-behavior-y: none; height: 100%; }
body, button, input, textarea { margin: 0; font-family: 'NexonLv2Gothic', sans-serif; background: $bg; }

header {
    padding: 20px 16px; text-align: center; background: #fff; border-bottom: 1px solid $line;
    h1 { margin: 0; font-size: 24px; font-weight: 700; cursor: pointer; display: inline-block; }
    p { margin: 8px 0 0; font-size: 16.8px; color: #666; line-height: 1.4; }
}

main { max-width: 1100px; margin: auto; padding: 16px; }
body.full-view {
    main { max-width: 100%; padding: 0; height: calc(100% - 60px); }
    header { border-bottom: none; }
}

.card { background: $card; border: 1px solid $line; border-radius: 10px; padding: 16px; margin-bottom: 16px; }

button, .sms-btn {
    display: block; width: 100%; padding: 9px 16px; border: none; border-radius: 8px; background: $brand; color: #fff; 
    font-weight: 600; cursor: pointer; margin: 6px 0; text-align: center; text-decoration: none; font-size: 16px; font-family: inherit;
    &.gray { background: #e5e7eb; color: #111; }
    &.green { background: $ok; }
    &.red { background: $bad; }
    &.fit { width: auto; min-width: 80px; display: inline-block; margin: 0 8px 0 0; padding: 9px 20px; }
    &.small { padding: 4px 10px; font-size: 13px; margin: 0; }
}

.btn-parent-input { width: auto !important; padding: 10px 30px !important; }

input, textarea {
    width: 100%; padding: 12px; border-radius: 8px; border: 1px solid $line; margin-top: 6px; line-height: 1.4; 
    font-size: 16px; color: #333; font-family: inherit; background: transparent;
    &:disabled { background: transparent; color: #333; border-color: #eee; }
    &::placeholder { color: #aaa; }
}

label { font-weight: 600; margin-top: 14px; display: flex; align-items: center; justify-content: space-between; }
textarea.purpose-box, textarea.plan-box { height: 100px !important; min-height: 100px !important; overflow-y: auto !important; resize: none; }

.top-actions {
    display: flex; gap: 8px; margin-bottom: 12px; justify-content: flex-start; align-items: center;
    .btn-submit, .btn-stats, .btn-cal, .btn-config { width: auto !important; margin: 0 !important; padding: 8px 18px !important; }
    .btn-cal { margin-left: auto !important; background: #4b5563; }
    .btn-config { background: #94a3b8; width: 40px !important; padding: 8px 0 !important; font-size: 18px; }
}

.top-search {
    display: flex; gap: 8px; align-items: center; margin-bottom: 16px;
    input { margin-top: 0; height: 38px; flex: 1; }
    button { height: 38px; margin: 0; min-width: 60px; width: 60px; padding: 0; white-space: nowrap; }
}

.table-wrapper { max-height: 540px; overflow-y: auto; border: 1px solid $line; border-radius: 8px; }
table {
    width: 100%; border-collapse: collapse; position: relative; table-layout: fixed;
    thead th { position: sticky; top: 0; background: #fdfdfd; z-index: 10; border-bottom: 2px solid $line; }
    th, td { padding: 12px; border-bottom: 1px solid $line; text-align: center; vertical-align: middle; }
    tr.approval-row { cursor: pointer; }
    td.title { text-align: left; line-height: 1.35; word-break: break-all; }
}

.badge { 
    padding: 6px 10px; border-radius: 6px; color: #fff; font-size: 13px; font-weight: 700; white-space: nowrap;
    &.ok { background: $ok; } &.no { background: $bad; } &.wait { background: $wait; }
}
.new-badge { background: #dc2626; color: #fff; font-size: 10px; padding: 2px 4px; border-radius: 4px; margin-right: 4px; font-weight: bold; }

.parent-result { margin-top: 12px; padding: 12px; border-radius: 8px; background: #f9fafb; border: 1px solid $line; line-height: 1.6; margin-bottom: 10px; }
.modal { position: fixed; inset: 0; background: rgba(0,0,0,.4); display: none; align-items: center; justify-content: center; padding: 16px; z-index: 1000; }
.modal .card { width: min(480px, 100%); max-height: 85vh; overflow-y: auto; }
.btn-row { display: flex; gap: 10px; margin-top: 20px; justify-content: center; button, .sms-btn { flex: 1; margin: 0; } }

/* 캘린더 스타일 유지 */
.cal-wrapper { background: #fff; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; width: 100%; }
.cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); background: $line; gap: 1px; flex: 1; }
.cal-day { background: #fff; padding: 4px; font-size: 13.2px; display: flex; flex-direction: column; &.today { outline: 1px solid #000; z-index: 1; } }
.cal-event-item { background-color: #eef2ff; padding: 1px 4px; border-radius: 2px; font-size: 10.8px; margin-top: 2px; }
</style>
<script src="https://cdn.jsdelivr.net/npm/sass.js@0.11.1/dist/sass.sync.js"></script>
</head>
<body>
<header id="main-header">
    <h1 onclick="goHome()">똑똑!! 가족 게시판</h1>
    <p id="header-desc">엄마와 아빠는 언제나 너의 멋진 계획을 응원해!</p>
</header>
<main id="app">데이터 로딩 중...</main>
<div id="pwModal" class="modal"></div>
<div id="statModal" class="modal"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyC4wyLWlZSDwNN8pqMSxiebB9z5CWrc93E",
  authDomain: "family-systems-4d19c.firebaseapp.com",
  databaseURL: "https://family-systems-4d19c-default-rtdb.firebaseio.com",
  projectId: "family-systems-4d19c",
  storageBucket: "family-systems-4d19c.firebasestorage.app",
  messagingSenderId: "670976286244",
  appId: "1:670976286244:web:84ae3450cbfc6823ec82b1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let config = { entryPw: "1111", masterPw: "1111", headerTitle: "똑똑!! 가족 게시판", headerDesc: "엄마와 아빠는 언제나 너의 멋진 계획을 응원해!" };
let route = { page: "list", id: null, date: null };
let keyword = "";
let allData = [];
let calendarData = {};
let currentCalDate = new Date();
let isAuthorized = localStorage.getItem("board_authorized") === "true"; 

// 초기 설정 로드
db.ref("tenants/test/config").on("value", (snap) => {
    if(snap.exists()) {
        config = snap.val();
        document.querySelector("header h1").innerText = config.headerTitle;
        document.getElementById("header-desc").innerText = config.headerDesc;
    }
});

db.ref("approvals").on("value", (snapshot) => {
  const val = snapshot.val();
  allData = val ? Object.keys(val).map(k => ({...val[k], dbId: k})) : [];
  if(isAuthorized && (route.page === "list" || route.page === "view")) render();
});

db.ref("tenants/test/calendar_v3").on("value", (snapshot) => {
  calendarData = snapshot.val() || {};
  if(isAuthorized && (route.page === 'calendar' || route.page === 'calDetail')) render();
});

window.onload = () => {
    if(!isAuthorized) checkEntryPassword();
    else render();
}

function checkEntryPassword() {
    const m = document.getElementById("pwModal");
    m.style.display = "flex";
    m.innerHTML = `<div class="card" style="text-align:center;"><b>접속 비밀번호</b><input id="entryPw" type="password" placeholder="비밀번호 입력" style="text-align:center;"><div class="btn-row"><button onclick="verifyEntryPw()">확인</button></div></div>`;
}

function verifyEntryPw() {
    if(document.getElementById("entryPw").value === config.entryPw) {
        isAuthorized = true;
        localStorage.setItem("board_authorized", "true"); 
        closeModal(); render();
    } else { alert("비밀번호가 틀렸습니다."); }
}

function goHome() { navigate({page:'list'}); }

function navigate(p, push=true){ 
    route = p; 
    if(push) history.pushState(p, "");
    render(); 
}

function render(){
  if(!isAuthorized) return;
  const app = document.getElementById("app");
  const header = document.getElementById("main-header");
  document.body.classList.remove("full-view");
  header.style.display = (route.page === "calendar") ? "none" : "block";

  if(route.page === "list"){
    let displayData = [...allData];
    if(keyword) displayData = displayData.filter(x => JSON.stringify(x).includes(keyword));
    displayData.sort((a,b) => b.time.localeCompare(a.time));

    app.innerHTML = `
      <div class="top-actions">
        <button class="btn-submit" onclick="navigate({page:'new'})">의견 올리기</button>
        <button class="btn-stats" onclick="openStats()">통계</button>
        <button class="btn-cal" onclick="navigate({page:'calendar'})">캘린더</button>
        <button class="btn-config" onclick="openConfigAuth()">⚙️</button>
      </div>
      <div class="top-search">
        <button class="gray" onclick="doSearch()">검색</button>
        <input id="q" placeholder="검색어 입력" value="${esc(keyword)}">
      </div>
      <div class="table-wrapper">
        <table>
          <colgroup><col style="width: 45px;"><col><col style="width: 75px;"></colgroup>
          <thead><tr><th>No</th><th>제목 / 상신시간</th><th>상태</th></tr></thead>
          <tbody>
            ${displayData.map((r,i)=>`
                <tr class="approval-row" onclick="navigate({page:'view', id:'${r.id}'})">
                  <td>${displayData.length - i}</td>
                  <td class="title"><div>${esc(r.title)}</div><small style="color:#888;">${r.time}</small></td>
                  <td>${badge(getStatus(r))}</td>
                </tr>`).join("")}
          </tbody>
        </table>
      </div>`;
  } 
  else if(route.page === "config"){
      app.innerHTML = `
        <div class="card">
            <h3>환경설정</h3>
            <label>접속 비밀번호</label>
            <input id="setEntryPw" type="password" value="${config.entryPw}">
            <label>부모 비밀번호 (승인/삭제용)</label>
            <input id="setMasterPw" type="password" value="${config.masterPw}">
            <div class="btn-row">
                <button onclick="saveConfig()">저장하기</button>
                <button class="gray" onclick="navigate({page:'list'})">취소</button>
            </div>
        </div>`;
  }
  else if(route.page === "new"){
    app.innerHTML = `<div class="card">
      <label>제목</label><input id="t" placeholder="무엇을 사거나 하고 싶나요?">
      <label>의견</label><textarea id="p" class="purpose-box"></textarea>
      <label>계획</label><textarea id="pl" class="plan-box"></textarea>
      <label>비용(원)</label><input id="c" oninput="this.value=formatComma(this.value)">
      <div class="btn-row"><button onclick="confirmSubmit()">의견 올리기</button><button class="gray" onclick="navigate({page:'list'})">취소</button></div>
    </div>`;
  }
  else if(route.page === "view"){
    const r = allData.find(x => String(x.id) === String(route.id));
    if(!r) return navigate({page:'list'});
    app.innerHTML = `
      <div class="card">
        <label>제목</label><input disabled value="${esc(r.title)}">
        <label>의견</label><textarea class="purpose-box" disabled>${esc(r.purpose)}</textarea>
        <label>계획</label><textarea class="plan-box" disabled>${esc(r.plan)}</textarea>
        <label>비용(원)</label><input disabled value="${formatComma(r.cost)}">
      </div>
      <div id="parentArea"></div>
      <div id="parentBtnWrapper" style="text-align:center;"><button class="btn-parent-input" onclick="openParentAuth('${r.id}')">부모 의견 입력</button></div>
      <div class="btn-row"><button class="gray" onclick="navigate({page:'list'})">목록</button><button class="red" onclick="askDelete('${r.dbId}')">삭제</button></div>`;
  }
  else if(route.page === "calendar"){ document.body.classList.add("full-view"); renderCalendarView(app); }
}

function openConfigAuth() {
    const m = document.getElementById("pwModal"); m.style.display = "flex";
    m.innerHTML = `<div class="card" style="text-align:center;"><b>부모 비밀번호 확인</b><input id="confPw" type="password" placeholder="비밀번호"><div class="btn-row"><button onclick="verifyConfigAuth()">확인</button><button class="gray" onclick="closeModal()">취소</button></div></div>`;
}
function verifyConfigAuth() {
    if(document.getElementById("confPw").value === config.masterPw) { closeModal(); navigate({page:'config'}); }
    else alert("비밀번호가 일치하지 않습니다.");
}
function saveConfig() {
    const entry = document.getElementById("setEntryPw").value;
    const master = document.getElementById("setMasterPw").value;
    db.ref("tenants/test/config").update({ entryPw: entry, masterPw: master }).then(() => { alert("저장되었습니다."); navigate({page:'list'}); });
}

function openParentAuth(id) {
    const m = document.getElementById("pwModal"); m.style.display = "flex";
    m.innerHTML = `<div class="card" style="text-align:center;"><b>부모 비밀번호 확인</b><input id="authPw" type="password"><div class="btn-row"><button onclick="verifyParentAuth('${id}')">확인</button><button class="gray" onclick="closeModal()">취소</button></div></div>`;
}
function verifyParentAuth(id) {
    if(document.getElementById("authPw").value === config.masterPw) { closeModal(); authParent(id); }
    else alert("비밀번호가 일치하지 않습니다.");
}

function askDelete(dbId){
  const m = document.getElementById("pwModal"); m.style.display="flex";
  m.innerHTML=`<div class="card" style="text-align:center;"><b>기록 삭제</b><input id="delPw" type="password" placeholder="부모 비밀번호"><div class="btn-row"><button onclick="authDelete('${dbId}')">삭제</button><button class="gray" onclick="closeModal()">취소</button></div></div>`;
}
function authDelete(dbId){
    if(document.getElementById("delPw").value === config.masterPw){ db.ref("approvals/"+dbId).remove().then(() => { navigate({page:'list'}); closeModal(); }); }
    else alert("비밀번호가 틀렸습니다.");
}

// 캘린더 등 나머지 기능 유지
function renderCalendarView(container) {
    container.innerHTML = `<div class="cal-wrapper"><div class="cal-header"><button class="gray small" onclick="changeMonth(-1)">◀</button><b>${currentCalDate.getFullYear()}년 ${currentCalDate.getMonth() + 1}월</b><button class="gray small" onclick="changeMonth(1)">▶</button></div><div id="currMonthView" style="flex:1"></div><div class="cal-footer"><button class="gray" onclick="navigate({page:'list'})">게시판 돌아가기</button></div></div>`;
    renderMonthGrid(currentCalDate, document.getElementById('currMonthView'));
}
function renderMonthGrid(dateObj, target) {
    const firstDay = new Date(dateObj.getFullYear(), dateObj.getMonth(), 1).getDay();
    const lastDate = new Date(dateObj.getFullYear(), dateObj.getMonth() + 1, 0).getDate();
    let html = `<div class="cal-grid">`;
    const days = ['일','월','화','수','목','금','토'];
    days.forEach(d => html += `<div style="text-align:center;padding:8px;font-weight:bold;background:#fdfdfd">${d}</div>`);
    for(let i=0; i<firstDay; i++) html += `<div class="cal-day" style="background:#fafafa"></div>`;
    for(let d=1; d<=lastDate; d++) html += `<div class="cal-day"><b>${d}</b></div>`;
    html += `</div>`; target.innerHTML = html;
}

function changeMonth(diff) { currentCalDate.setMonth(currentCalDate.getMonth() + diff); render(); }
function closeModal() { document.getElementById("pwModal").style.display = "none"; }
function esc(s){ return String(s??"").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
function formatComma(v){ return String(v).replace(/[^0-9]/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
function getStatus(r){ if(r.mom === "pending" || r.dad === "pending") return "대기"; return (r.mom === "approve" && r.dad === "approve") ? "찬성" : "반대"; }
function badge(s){ return `<span class="badge ${s==='찬성'?'ok':(s==='반대'?'no':'wait')}">${s}</span>`; }
function now(){ const d=new Date(); return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0")+" "+String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0"); }

window.onpopstate = (e) => { if(e.state) { route = e.state; render(); } };
</script>
</body>
</html>
