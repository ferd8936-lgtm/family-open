<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
<title>ë˜‘ë˜‘!! ê°€ì¡± ê²Œì‹œíŒ</title>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

<style>
/* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ê·¸ëŒ€ë¡œ ìœ ì§€ (ìƒëµ ì—†ìŒ) */
@font-face { font-family: 'NexonLv2Gothic'; src: url('NexonLv2Gothic_2.ttf') format('truetype'); }
:root{--bg:#f8fafc;--card:#ffffff;--line:#e5e7eb;--brand:#6366f1;--ok:#16a34a;--bad:#dc2626;--wait:#d97706;}
*{box-sizing:border-box}
html, body { overscroll-behavior-y: none; height: 100%; }
body, button, input, textarea {margin:0; font-family:'NexonLv2Gothic', sans-serif; background:var(--bg);}
header{padding:20px 16px;text-align:center;background:#fff;border-bottom:1px solid var(--line);}
header h1 {margin:0; font-size:24px; font-weight:700; cursor: pointer; display: inline-block;}
header p {margin:8px 0 0; font-size:16.8px; color:#666; line-height: 1.4;}
main{max-width:1100px;margin:auto;padding:16px;}
body.full-view main { max-width: 100%; padding: 0; height: calc(100% - 60px); }
body.full-view header { border-bottom: none; }
.card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:16px;margin-bottom:16px;}
button, .sms-btn{display:block; width:100%; padding:9px 16px;border:none;border-radius:8px;background:var(--brand);color:#fff;font-weight:600;cursor:pointer;margin:6px 0; text-align:center; text-decoration:none; font-size:16px; font-family: inherit;}
button.gray, .sms-btn.gray{background:#e5e7eb;color:#111}
button.green{background:var(--ok)}
button.red{background:var(--bad)}
button.fit {width: auto; min-width: 80px; display: inline-block; margin: 0 8px 0 0; padding: 9px 20px;}
.btn-parent-input { width: auto !important; padding: 10px 30px !important; }
button.small{padding: 4px 10px; font-size: 13px; margin: 0;}
input, textarea {width:100%;padding:12px;border-radius:8px;border:1px solid var(--line);margin-top:6px;line-height:1.4;letter-spacing: -0.5px !important;font-size: 16px; color: #333;font-family: inherit; background: transparent;}
input:disabled, textarea:disabled { background: transparent; color: #333; border-color: #eee; }
input::placeholder, textarea::placeholder { color: #aaa; }
label{font-weight:600;margin-top:14px;display:flex; align-items: center; justify-content: space-between;}
textarea.purpose-box, textarea.plan-box { height: 100px !important; min-height: 100px !important; overflow-y: auto !important; resize: none; }
.top-actions {display:flex; gap:8px; margin-bottom:12px; justify-content: flex-start; align-items: center;}
.btn-submit, .btn-stats, .btn-cal {width: auto !important; margin: 0 !important; padding: 8px 18px !important;}
.btn-cal { margin-left: auto !important; background: #4b5563; }
.top-search {display: flex; gap: 8px; align-items: center; margin-bottom: 16px;}
.top-search input {margin-top: 0; height: 38px; flex: 1;}
.top-search button {height: 38px; margin: 0; min-width: 60px; width: 60px; padding: 0; white-space: nowrap;}
.table-wrapper {max-height: 540px;overflow-y: auto;border: 1px solid var(--line);border-radius: 8px;}
table{width:100%; border-collapse:collapse; position: relative; table-layout: fixed;}
thead th {position: sticky;top: 0;background: #fdfdfd;z-index: 10;border-bottom: 2px solid var(--line);}
th,td{padding:12px;border-bottom:1px solid var(--line);text-align:center;vertical-align:middle;}
tr.approval-row {cursor: pointer;-webkit-user-select: none;user-select: none;}
td.title{text-align:left; line-height:1.35; word-break: break-all;}
.badge{padding:6px 10px;border-radius:6px;color:#fff;font-size:13px;font-weight:700; white-space: nowrap;}
.ok{background:var(--ok)}.no{background:var(--bad)}.wait{background:var(--wait)}
.new-badge {background:#dc2626; color:#fff; font-size:10px; padding:2px 4px; border-radius:4px; margin-right:4px; vertical-align: middle; font-weight: bold;}
.parent-result{margin-top:12px;padding:12px;border-radius:8px;background:#f9fafb;border:1px solid var(--line); line-height: 1.6; margin-bottom: 10px;}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:16px;z-index: 1000;}
.modal .card{width:min(480px,100%); max-height: 85vh; overflow-y: auto;}
.btn-row {display: flex; gap: 10px; margin-top: 20px; justify-content: center;}
.btn-row button, .btn-row .sms-btn {flex: 1; margin: 0;}
.view-time-header {font-size: 14px;color: #666;margin-bottom: 10px;text-align: right;}
.cal-wrapper { background: #fff; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; touch-action: none; position: relative; width: 100%; }
.cal-container { display: flex; width: 300%; flex: 1; min-height: 0; transition: transform 0.3s ease-out; }
.cal-month-view { width: 33.333%; height: 100%; display: flex; flex-direction: column; }
.cal-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: #fff; border-bottom: 1px solid var(--line); flex-shrink: 0; }
.cal-header button { width: 34px !important; height: 34px; padding: 0 !important; font-size: 14px; }
.cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); grid-template-rows: auto repeat(6, 1fr); background: var(--line); gap: 1px; flex: 1; border-bottom: 1px solid var(--line); width: 100%; overflow: hidden; }
.cal-day-label { background: #fdfdfd; padding: 8px 0; text-align: center; font-size: 13px; font-weight: bold; }
.cal-day { background: #fff; padding: 4px; font-size: 13.2px; cursor: pointer; display: flex; flex-direction: column; gap: 4px; position: relative; overflow: hidden; font-family: 'NexonLv2Gothic', sans-serif; }
.cal-day-num-box { display: flex; align-items: center; gap: 4px; }
.cal-day.sun, .cal-day.holiday { color: red; }
.cal-day.sat { color: blue; }
.cal-day.other { color: #ccc !important; background: #fafafa; }
.cal-day.today { background: #fff; outline: 1px solid #000; outline-offset: -1px; z-index: 1; }
.holiday-text { font-size: 10.8px; font-weight: bold; line-height: 1; display: inline-block; font-family: 'NexonLv2Gothic', sans-serif; margin-left: 2px; white-space: nowrap; overflow: hidden; text-overflow: clip; max-width: 75%; }
.holiday-red { color: red; }
.holiday-black { color: black; }
.cal-event-container { display: flex; flex-direction: column; gap: 2px; width: 100%; overflow: hidden; flex: 1; }
.cal-event-item { color: #000; background-color: #eef2ff; padding: 1px 4px; border-radius: 2px; font-size: 10.8px; line-height: 1.1; width: 100%; display: block; overflow: hidden; word-break: break-all; white-space: normal; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; text-overflow: clip; }
.many-events .cal-event-item { -webkit-line-clamp: 1; }
.cal-event-item.repeated { background-color: #fef9c3; }
.cal-event-item.multi-day { background-color: #dcfce7; }
.btn-repeat-action { background: #fff !important; color: #000 !important; border: 1px solid var(--line) !important; margin: 4px 0 !important; font-weight: 500 !important; width: 100%; }
.cal-footer { padding: 10px 15px; background: #fff; flex-shrink: 0; border-top: 1px solid var(--line); }
.flex-align-center { display: flex; align-items: center; gap: 8px; margin-top: 10px; }
.flex-align-center input[type="checkbox"] { width: 18px; height: 18px; margin: 0; cursor: pointer; }
.flex-align-center label { margin: 0; cursor: pointer; font-weight: 500; }
.stat-item {border: 1px solid var(--line); border-radius: 8px; padding: 15px; margin-bottom: 10px; line-height: 1.6;}
</style>
</head>
<body>
<header id="main-header">
    <h1 onclick="goHome()">ë˜‘ë˜‘!! ê°€ì¡± ê²Œì‹œíŒ</h1>
    <p id="header-desc">ì—„ë§ˆì™€ ì•„ë¹ ëŠ” ì–¸ì œë‚˜ ë„ˆì˜ ë©‹ì§„ ê³„íšì„ ì‘ì›í•´!</p>
</header>
<main id="app">ë°ì´í„° ë¡œë”© ì¤‘...</main>
<div id="pwModal" class="modal"></div>
<div id="statModal" class="modal"></div>

<script>
/* [SaaS í•µì‹¬ ë¡œì§] URL íŒŒë¼ë¯¸í„°ì—ì„œ ê°€ì¡± ID ì¶”ì¶œ */
const urlParams = new URLSearchParams(window.location.search);
const FAMILY_ID = urlParams.get('f') || 'default'; // ?f=ê°€ì¡±ì•„ì´ë”” ê°€ ì—†ìœ¼ë©´ default ì‚¬ìš©

const firebaseConfig = {
  apiKey: "AIzaSyC4wyLWlZSDwNN8pqMSxiebB9z5CWrc93E",
  authDomain: "family-systems-4d19c.firebaseapp.com",
  databaseURL: "https://family-systems-4d19c-default-rtdb.firebaseio.com",
  projectId: "family-systems-4d19c",
  storageBucket: "family-systems-4d19c.firebasestorage.app",
  messagingSenderId: "670976286244",
  appId: "1:670976286244:web:84ae3450cbfc6823ec82b1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* [SaaS í•µì‹¬ ë¡œì§] ë¹„ë°€ë²ˆí˜¸ ë° ì„¤ì •ê°’ì„ DB í…Œë„ŒíŠ¸ ê²½ë¡œì—ì„œ ê°€ì ¸ì˜¤ê¸° */
let PASSWORD = "7102"; // ë¶€ëª¨ ë¹„ë²ˆ ê¸°ë³¸ê°’
let ENTRY_PASSWORD = "5677"; // ì ‘ì† ë¹„ë²ˆ ê¸°ë³¸ê°’
let familyConfig = {};

// í…Œë„ŒíŠ¸ë³„ ë°ì´í„° ê²½ë¡œ ì„¤ì •
const BASE_PATH = `tenants/${FAMILY_ID}/`;

let route = { page: "list", id: null, date: null };
let keyword = "";
let allData = [];
let calendarData = {};
let currentCalDate = new Date();
let tempParentInput = { momC: "", dadC: "" };
let editingCalId = null;
let isAuthorized = localStorage.getItem(`auth_${FAMILY_ID}`) === "true"; 

const holidays = { /* ê¸°ì¡´ ê³µíœ´ì¼ ë°ì´í„° ìœ ì§€ */
    "01-01": { name: "ì‹ ì •", red: true }, "03-01": { name: "ì‚¼ì¼ì ˆ", red: true }, "05-01": { name: "ê·¼ë¡œìì˜ë‚ ", red: false }, "05-05": { name: "ì–´ë¦°ì´ë‚ ", red: true }, "05-08": { name: "ì–´ë²„ì´ë‚ ", red: false }, "06-06": { name: "í˜„ì¶©ì¼", red: true }, "08-15": { name: "ê´‘ë³µì ˆ", red: true }, "10-01": { name: "êµ­êµ°ì˜ë‚ ", red: false }, "10-03": { name: "ê°œì²œì ˆ", red: true }, "10-09": { name: "í•œê¸€ë‚ ", red: true }, "12-25": { name: "ì„±íƒ„ì ˆ", red: true },
    "2026-02-16": { name: "ì„¤ë‚ ", red: true }, "2026-02-17": { name: "ì„¤ë‚ ", red: true }, "2026-02-18": { name: "ì„¤ë‚ ", red: true }, "2026-05-24": { name: "ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ", red: true }, "2026-09-24": { name: "ì¶”ì„", red: true }, "2026-09-25": { name: "ì¶”ì„", red: true }, "2026-09-26": { name: "ì¶”ì„", red: true },
    "2027-02-06": { name: "ì„¤ë‚ ", red: true }, "2027-02-07": { name: "ì„¤ë‚ ", red: true }, "2027-02-08": { name: "ì„¤ë‚ ", red: true }, "2027-02-09": { name: "ëŒ€ì²´ê³µíœ´ì¼", red: true }, "2027-05-13": { name: "ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ", red: true }, "2027-09-14": { name: "ì¶”ì„", red: true }, "2027-09-15": { name: "ì¶”ì„", red: true }, "2027-09-16": { name: "ì¶”ì„", red: true }
};

// [SaaS í•µì‹¬ ë¡œì§] í•´ê²° ë‹¨ê³„ 2: ê°•ì œ ë¡œë”© ì•ˆì „ì¥ì¹˜ ì¶”ê°€
let isInitialized = false;

db.ref(`${BASE_PATH}config`).on("value", (snap) => {
    const val = snap.val();
    if(val) {
        familyConfig = val;
        PASSWORD = String(val.masterPw || "7102"); 
        ENTRY_PASSWORD = String(val.entryPw || "5677");
        if(val.headerTitle) document.querySelector('h1').innerText = val.headerTitle;
        if(val.headerDesc) document.getElementById('header-desc').innerText = val.headerDesc;
    }
    // ë°ì´í„°ê°€ ë¡œë“œë˜ë©´ ì´ˆê¸°í™” ì‹¤í–‰
    if(!isInitialized) {
        isInitialized = true;
        init();
    }
});

// ì•ˆì „ì¥ì¹˜: íŒŒì´ì–´ë² ì´ìŠ¤ ì‘ë‹µì´ 2ì´ˆ ì´ìƒ ì§€ì—°ë  ê²½ìš° ê¸°ë³¸ê°’ìœ¼ë¡œ ê°•ì œ ì‹¤í–‰
setTimeout(() => {
    if(!isInitialized) {
        console.warn("íŒŒì´ì–´ë² ì´ìŠ¤ ì„¤ì • ë¡œë”© ì§€ì—° - ê¸°ë³¸ê°’ìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤.");
        isInitialized = true;
        init();
    }
}, 2000);

function init() {
    if(!isAuthorized) {
        checkEntryPassword();
    } else {
        render();
    }
}

function checkEntryPassword() {
    const m = document.getElementById("pwModal");
    m.style.display = "flex";
    m.innerHTML = `<div class="card" style="text-align:center;"><b>[${FAMILY_ID}] ì ‘ì† ë¹„ë°€ë²ˆí˜¸</b><p style="font-size:14px; margin-top:8px;">ê°€ì¡± ê²Œì‹œíŒ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p><input id="entryPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" style="text-align:center;"><div class="btn-row"><button onclick="verifyEntryPw()">í™•ì¸</button></div></div>`;
}

function verifyEntryPw() {
    const val = document.getElementById("entryPw").value;
    if(val === ENTRY_PASSWORD) {
        isAuthorized = true;
        localStorage.setItem(`auth_${FAMILY_ID}`, "true"); 
        closeModal();
        render();
    } else {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); 
    }
}

function closeModal() {
    document.getElementById("pwModal").style.display = "none";
}

// [SaaS í•µì‹¬ ë¡œì§] ëª¨ë“  ë°ì´í„° ì°¸ì¡°ë¥¼ BASE_PATH í•˜ìœ„ë¡œ ë³€ê²½
db.ref(`${BASE_PATH}approvals`).on("value", (snapshot) => {
  const val = snapshot.val();
  allData = val ? Object.keys(val).map(k => ({...val[k], dbId: k})) : [];
  const parentArea = document.getElementById("parentArea");
  if(isAuthorized && (route.page === "list" || route.page === "view")) {
      if(!(parentArea && parentArea.innerHTML !== "")) render(); 
  }
});

db.ref(`${BASE_PATH}calendar_v3`).on("value", (snapshot) => {
  calendarData = snapshot.val() || {};
  if(isAuthorized && (route.page === 'calendar' || route.page === 'calDetail')) render();
});

/* ì•„ë˜ ê¸°ëŠ¥ í•¨ìˆ˜ë“¤ì€ ê¸°ì¡´ ë¡œì§ 100% ë™ì¼í•˜ë˜, DB ì°¸ì¡° ê²½ë¡œì— BASE_PATHë§Œ ì ìš©ë¨ */

function goHome() { navigate({page:'list'}); }
function navigate(p, push=true){ 
  route = p; 
  if(push) {
      if(p.page === 'list') { window.history.pushState(null, "", window.location.pathname + window.location.search); window.history.replaceState(p, ""); }
      else { history.pushState(p, ""); }
  }
  render(); 
}

function render(){
  if(!isAuthorized) return;
  const app = document.getElementById("app");
  const header = document.getElementById("main-header");
  document.body.classList.remove("full-view");
  header.style.display = (route.page === "calendar") ? "none" : "block";

  if(route.page === "list"){
    let displayData = [...allData];
    if(keyword) displayData = displayData.filter(x => JSON.stringify(x).includes(keyword));
    displayData.sort((a,b) => b.time.localeCompare(a.time));
    const readList = JSON.parse(localStorage.getItem('readApprovals') || '[]');
    app.innerHTML = `
      <div class="top-actions">
        <button class="btn-submit" onclick="navigate({page:'new'})">ì˜ê²¬ ì˜¬ë¦¬ê¸°</button>
        <button class="btn-stats" onclick="openStats()">í†µê³„</button>
        <button class="btn-cal" onclick="navigate({page:'calendar'})">ìº˜ë¦°ë”</button>
        <button class="small gray" onclick="navigate({page:'config'})" style="margin-left:auto; width:auto; padding:8px;">âš™ï¸</button>
      </div>
      <div class="top-search">
        <button class="gray" onclick="doSearch()">ê²€ìƒ‰</button>
        <input id="q" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" value="${esc(keyword)}">
      </div>
      <div class="table-wrapper">
        <table>
          <colgroup><col style="width: 45px;"><col><col style="width: 75px;"></colgroup>
          <thead><tr><th>No</th><th>ì œëª© / ìƒì‹ ì‹œê°„</th><th>ìƒíƒœ</th></tr></thead>
          <tbody>
            ${displayData.map((r,i)=>{
              const status = getStatus(r);
              const isNew = !readList.includes(r.id) && status === 'ëŒ€ê¸°';
              return `<tr class="approval-row" onclick="navigate({page:'view', id:'${r.id}'})">
                  <td>${displayData.length - i}</td>
                  <td class="title"><div>${isNew ? '<span class="new-badge">NEW</span>' : ''}${esc(r.title)}</div><small style="color:#888;">${r.time}</small></td>
                  <td>${badge(status)}</td>
                </tr>`;
            }).join("")}
          </tbody>
        </table>
      </div>`;
  } 
  else if(route.page === "new"){
    app.innerHTML = `<div class="card">
      <label>ì œëª©</label><input id="t" placeholder="ë¬´ì—‡ì„ ì‚¬ê±°ë‚˜ í•˜ê³  ì‹¶ë‚˜ìš”?">
      <label>ì˜ê²¬</label><textarea id="p" class="purpose-box" placeholder="ì™œ í•„ìš”í•œê°€ìš”?"></textarea>
      <label>ê³„íš</label><textarea id="pl" class="plan-box" placeholder="ê³„íšì„ ìì„¸í•˜ê²Œ ì ì–´ì£¼ì„¸ìš”"></textarea>
      <label>ë¹„ìš©(ì›)</label><input id="c" type="text" placeholder="ê¸ˆì•¡ ì…ë ¥" oninput="this.value=formatComma(this.value)">
      <div class="btn-row"><button onclick="confirmSubmit()">ì˜ê²¬ ì˜¬ë¦¬ê¸°</button><button class="gray" onclick="navigate({page:'list'})">ì·¨ì†Œ</button></div>
    </div>`;
  }
  else if(route.page === "view"){
    const r = allData.find(x => String(x.id) === String(route.id));
    if(!r) return navigate({page:'list'});
    const showParentBtn = document.getElementById("parentArea") && document.getElementById("parentArea").innerHTML !== "" ? "none" : "block";
    app.innerHTML = `
      <div class="view-time-header">ìƒì‹ : ${r.time}</div>
      <div class="card">
        <label style="margin-top:0;">ì œëª©<button id="btnEditMain" class="small gray" style="width: auto; margin-left: auto;" onclick="toggleEdit('${r.dbId}')">ìˆ˜ì •</button></label>
        <input id="view-title" disabled value="${esc(r.title)}">
        <label>ì˜ê²¬</label><textarea id="view-purpose" class="purpose-box" disabled>${esc(r.purpose)}</textarea>
        <label>ê³„íš</label><textarea id="view-plan" class="plan-box" disabled>${esc(r.plan)}</textarea>
        <label>ë¹„ìš©(ì›)</label><input id="view-cost" disabled type="text" value="${formatComma(r.cost)}">
      </div>
      <div id="parentViewLog" class="parent-result"><div style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;"><b>ë¶€ëª¨ ì˜ê²¬ ê¸°ë¡</b></div>
        ${renderLog('ì—„ë§ˆ', r.mom, r.momC, r.momTime)}${renderLog('ì•„ë¹ ', r.dad, r.dadC, r.dadTime)}
      </div>
      <div id="parentArea"></div>
      <div id="parentBtnWrapper" style="text-align:center; margin-bottom:10px; display: ${showParentBtn};">
        <button class="btn-parent-input" onclick="openParent('${r.id}')">ë¶€ëª¨ ì˜ê²¬ ì…ë ¥</button>
      </div>
      <div class="btn-row"><button class="gray" onclick="navigate({page:'list'})">ëª©ë¡</button><button class="red" onclick="askDelete('${r.dbId}')">ì‚­ì œ</button></div>`;
  }
  else if(route.page === "calendar"){ document.body.classList.add("full-view"); renderCalendarView(app); }
  else if(route.page === "calDetail"){ renderCalendarDetail(app); }
  else if(route.page === "config"){
    app.innerHTML = `<div class="card">
      <h3>ê°€ì¡± ì„¤ì • (${FAMILY_ID})</h3>
      <label>ê²Œì‹œíŒ ì œëª©</label><input id="cfgTitle" value="${esc(familyConfig.headerTitle || 'ë˜‘ë˜‘!! ê°€ì¡± ê²Œì‹œíŒ')}">
      <label>í™˜ì˜ ë©”ì‹œì§€</label><input id="cfgDesc" value="${esc(familyConfig.headerDesc || 'ì—„ë§ˆì™€ ì•„ë¹ ëŠ” ì–¸ì œë‚˜ ë„ˆì˜ ë©‹ì§„ ê³„íšì„ ì‘ì›í•´!')}">
      <label>ì ‘ì† ë¹„ë°€ë²ˆí˜¸ (í˜„ì¬: ${ENTRY_PASSWORD})</label><input id="cfgEntry" type="text" placeholder="ìƒˆ ì ‘ì† ë¹„ë²ˆ">
      <label>ë¶€ëª¨ ìŠ¹ì¸ ë¹„ë°€ë²ˆí˜¸ (í˜„ì¬: ${PASSWORD})</label><input id="cfgMaster" type="text" placeholder="ìƒˆ ìŠ¹ì¸ ë¹„ë²ˆ">
      <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
      <p style="font-size:12px; color:red;">â€» ë¹„ë°€ë²ˆí˜¸ ìˆ˜ì • ì‹œ ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.</p>
      <div class="btn-row"><button onclick="saveConfig()">ì„¤ì • ì €ì¥</button><button class="gray" onclick="navigate({page:'list'})">ë‹«ê¸°</button></div>
    </div>`;
  }
}

function saveConfig() {
    const title = document.getElementById("cfgTitle").value;
    const desc = document.getElementById("cfgDesc").value;
    const entry = document.getElementById("cfgEntry").value || ENTRY_PASSWORD;
    const master = document.getElementById("cfgMaster").value || PASSWORD;
    
    db.ref(`${BASE_PATH}config`).update({
        headerTitle: title,
        headerDesc: desc,
        entryPw: entry,
        masterPw: master
    }).then(() => { alert("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); navigate({page:'list'}); });
}

function submit(){
  const t = document.getElementById("t").value.trim();
  const rawC = document.getElementById("c").value.replace(/,/g, '').trim();
  const p = document.getElementById("p").value.trim();
  const pl = document.getElementById("pl").value.trim();
  const newPost = { id: Date.now().toString(), title:t, purpose:p, plan:pl, cost:rawC, time:now(), mom: "pending", dad: "pending", momC: "", dadC: "", momTime: "", dadTime: "" };
  db.ref(`${BASE_PATH}approvals`).push(newPost).then(() => { navigate({page:'list'}); });
}

function saveCal(dateKey) {
    const title = document.getElementById("calTitle").value.trim();
    const isAllDay = document.getElementById("calAllDay").checked;
    const time = isAllDay ? "00:00" : document.getElementById("calTime").value;
    const content = document.getElementById("calContent").value.trim();
    const repeat = document.getElementById("calRepeat").checked;
    const startDate = document.getElementById("calStartDate").value;
    const endDate = document.getElementById("calEndDate").value;
    if(!title) return alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    const data = { title, time, content, repeated: repeat, startDate, endDate, isAllDay };
    
    if (editingCalId) {
        db.ref(`${BASE_PATH}calendar_v3/${dateKey}/${editingCalId}`).update(data).then(() => { editingCalId = null; render(); });
    } else {
        createNewCalendarEntry(startDate, endDate, repeat, data);
    }
}

function createNewCalendarEntry(startDate, endDate, repeat, data, existingRepeatId = null) {
    const updates = {}; const repeatId = existingRepeatId || "rep_" + Date.now();
    let start = new Date(startDate); let end = new Date(endDate);
    while(start <= end) {
        const dStr = start.getFullYear() + '-' + String(start.getMonth() + 1).padStart(2, '0') + '-' + String(start.getDate()).padStart(2, '0');
        const newKey = db.ref(`${BASE_PATH}calendar_v3/` + dStr).push().key; 
        updates[`${dStr}/${newKey}`] = { ...data, repeatId }; start.setDate(start.getDate() + 1);
    }
    db.ref(`${BASE_PATH}calendar_v3`).update(updates).then(() => { editingCalId = null; render(); });
}

function getSmsUrl(text) { const ua = navigator.userAgent.toLowerCase(); return /iphone|ipad|ipod/.test(ua) ? `sms:&body=${encodeURIComponent(text)}` : `sms:?body=${encodeURIComponent(text)}`; }
function confirmSubmit() { const t = document.getElementById("t").value.trim(); const p = document.getElementById("p").value.trim(); const pl = document.getElementById("pl").value.trim(); const rawC = document.getElementById("c").value.replace(/,/g, '').trim(); if(!t || !p || !pl || !rawC) return alert("ëª¨ë“  ì¹¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); submit(); }
function changeMonth(diff) { currentCalDate.setMonth(currentCalDate.getMonth() + diff); render(); }
function now(){ const d=new Date(); return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0")+" "+String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0"); }
function formatComma(v){ return String(v).replace(/[^0-9]/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
function esc(s){ return String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function getStatus(r){ const mom = r.mom || "pending"; const dad = r.dad || "pending"; if(mom === "pending" || dad === "pending") return "ëŒ€ê¸°"; return (mom === "approve" && dad === "approve") ? "ì°¬ì„±" : "ë°˜ëŒ€"; }
function badge(s){ return `<span class="badge ${s==='ì°¬ì„±'?'ok':(s==='ë°˜ëŒ€'?'no':'wait')}">${s}</span>`; }
function transKo(v){ return v === "approve" ? "ì°¬ì„±" : (v === "reject" ? "ë°˜ëŒ€" : "ëŒ€ê¸°"); }
function renderLog(name, res, comm, time) { const icon = res === 'approve' ? 'âœ…' : (res === 'reject' ? 'âŒ' : 'â³'); return `<div style="margin-bottom:15px;"><b>${name}: ${icon} ${transKo(res)} ${time ? '/ '+time : ''}</b><br><div style="margin-top:8px; padding-left:10px; color:#555;">ì˜ê²¬: ${esc(comm || "-")}</div></div>`; }
function toggleEdit(dbId) { const btn = document.getElementById("btnEditMain"); if(btn.innerText !== "ì €ì¥") { ["view-title", "view-purpose", "view-plan", "view-cost"].forEach(id => document.getElementById(id).disabled = false); btn.innerText = "ì €ì¥"; btn.classList.add("green"); } else { const updates = { title: document.getElementById("view-title").value.trim(), purpose: document.getElementById("view-purpose").value.trim(), plan: document.getElementById("view-plan").value.trim(), cost: document.getElementById("view-cost").value.replace(/,/g, '') }; db.ref(`${BASE_PATH}approvals/`+dbId).update(updates).then(() => { render(); }); } }
function askDelete(dbId){ const m = document.getElementById("pwModal"); m.style.display="flex"; m.innerHTML=`<div class="card" style="text-align:center;"><b>ê¸°ë¡ ì‚­ì œ</b><input id="delPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸"><div class="btn-row"><button class="fit" onclick="authDelete('${dbId}')">í™•ì¸</button><button class="fit gray" onclick="closeModal()">ë‹«ê¸°</button></div></div>`; }
function authDelete(dbId){ if(document.getElementById("delPw").value === PASSWORD){ db.ref(`${BASE_PATH}approvals/`+dbId).remove().then(() => { navigate({page:'list'}); closeModal(); }); } else { alert("ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜"); } }
function openParent(id){ const m = document.getElementById("pwModal"); m.style.display="flex"; m.innerHTML=`<div class="card" style="text-align:center;"><b>ë¶€ëª¨ ì¸ì¦</b><input id="pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸"><div class="btn-row"><button class="fit" onclick="authParent('${id}')">í™•ì¸</button><button class="fit gray" onclick="closeModal()">ë‹«ê¸°</button></div></div>`; }
function authParent(id){ if(document.getElementById("pw").value!==PASSWORD) return alert("ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜"); closeModal(); authParentView(id); }
function authParentView(id){
  const r = allData.find(x=>String(x.id)===String(id));
  const logArea = document.getElementById("parentViewLog"); if(logArea) logArea.style.display = "none";
  let h = "";
  ['mom', 'dad'].forEach(who => {
      const whoKo = who === 'mom' ? 'ì—„ë§ˆ' : 'ì•„ë¹ '; const res = r[who]; 
      h += `<div class="card"><b>${whoKo} ì˜ê²¬</b><textarea id="${who}C" rows="3">${r[who+'C'] || ''}</textarea><div class="btn-row"><button class="green" onclick="decide('${r.dbId}','${who}','approve')">ì°¬ì„±</button><button class="red" onclick="decide('${r.dbId}','${who}','reject')">ë°˜ëŒ€</button></div></div>`;
  });
  document.getElementById("parentArea").innerHTML = h;
  document.getElementById("parentBtnWrapper").style.display = "none";
}
function decide(dbId, who, val){
    const comment = document.getElementById(who+"C").value;
    db.ref(`${BASE_PATH}approvals/`+dbId).update({ [who]: val, [who+"C"]: comment, [who+"Time"]: now() }).then(() => { navigate({page:'list'}); });
}
function doSearch(){ keyword = document.getElementById("q").value.trim(); render(); }
function openStats(){
  const stats = {}; allData.filter(x => getStatus(x) !== "ëŒ€ê¸°").forEach(item => { const key = item.time.substring(0,7).replace("-","ë…„ ") + "ì›”"; if(!stats[key]) stats[key] = {app:0, appS:0, rej:0, rejS:0}; const s = getStatus(item), c = Number(item.cost); if(s==="ì°¬ì„±"){ stats[key].app++; stats[key].appS+=c; } else { stats[key].rej++; stats[key].rejS+=c; } });
  const sorted = Object.keys(stats).sort().reverse(), m = document.getElementById("statModal"); m.style.display="flex";
  m.innerHTML = `<div class="card"><h3>ì›”ê°„ í†µê³„</h3><div class="table-wrapper">${sorted.map(k=>`<div class="stat-item"><b>${k}</b><br>âœ… ì°¬ì„±: ${stats[k].app}ê±´ (${stats[k].appS.toLocaleString()}ì›) <br>âŒ ë°˜ëŒ€: ${stats[k].rej}ê±´ (${stats[k].rejS.toLocaleString()}ì›)</div>`).join("")}</div><button onclick="closeModalStat()">ë‹«ê¸°</button></div>`;
}
function closeModalStat() { document.getElementById("statModal").style.display="none"; }

/* ìº˜ë¦°ë” ê´€ë ¨ ë Œë”ë§ í•¨ìˆ˜ë“¤ (ê¸°ì¡´ ë¡œì§ ìœ ì§€) */
function renderCalendarView(container) {
    const year = currentCalDate.getFullYear(); const month = currentCalDate.getMonth();
    container.innerHTML = `
        <div class="cal-wrapper">
            <div class="cal-header">
                <button onclick="changeMonth(-1)">â—€</button>
                <div style="font-size:18px; font-weight:bold;">${year}ë…„ ${month + 1}ì›”</div>
                <button onclick="changeMonth(1)">â–¶</button>
                <button onclick="navigate({page:'list'})" style="margin-left:10px;">ğŸ </button>
            </div>
            <div class="cal-grid">
                ${['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].map(d => `<div class="cal-day-label">${d}</div>`).join('')}
                ${getCalendarDays(year, month)}
            </div>
            <div class="cal-footer">
                <button onclick="navigate({page:'calDetail', date:'${now().split(' ')[0]}'})">+ ì¼ì • ì¶”ê°€</button>
            </div>
        </div>
    `;
}

function getCalendarDays(year, month) {
    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month + 1, 0).getDate();
    const prevLastDate = new Date(year, month, 0).getDate();
    let days = [];
    for (let i = firstDay - 1; i >= 0; i--) days.push(renderDay(year, month - 1, prevLastDate - i, true));
    for (let i = 1; i <= lastDate; i++) days.push(renderDay(year, month, i));
    const nextDays = 42 - days.length;
    for (let i = 1; i <= nextDays; i++) days.push(renderDay(year, month + 1, i, true));
    return days.join('');
}

function renderDay(y, m, d, isOther = false) {
    const date = new Date(y, m, d);
    const dateKey = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
    const day = date.getDay();
    let cls = isOther ? 'other ' : '';
    if (day === 0) cls += 'sun'; else if (day === 6) cls += 'sat';
    const hKey = `${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
    const holiday = holidays[hKey] || holidays[dateKey];
    if (holiday && holiday.red) cls += ' holiday';
    const events = calendarData[dateKey] || {};
    return `
        <div class="cal-day ${cls}" onclick="navigate({page:'calDetail', date:'${dateKey}'})">
            <div class="cal-day-num-box">
                <span>${d}</span>
                ${holiday ? `<span class="holiday-text ${holiday.red ? 'holiday-red' : 'holiday-black'}">${holiday.name}</span>` : ''}
            </div>
            <div class="cal-event-container">
                ${Object.keys(events).map(id => `<div class="cal-event-item">${esc(events[id].title)}</div>`).join('')}
            </div>
        </div>
    `;
}

function renderCalendarDetail(container) {
    const dateKey = route.date;
    const events = calendarData[dateKey] || {};
    container.innerHTML = `
        <div class="card">
            <h3>${dateKey} ì¼ì •</h3>
            <div id="calEventList">
                ${Object.keys(events).map(id => `
                    <div class="stat-item">
                        <b>${esc(events[id].time)} ${esc(events[id].title)}</b>
                        <p>${esc(events[id].content)}</p>
                        <button class="small gray" onclick="editCalEvent('${dateKey}','${id}')">ìˆ˜ì •</button>
                        <button class="small red" onclick="deleteCal('${dateKey}','${id}')">ì‚­ì œ</button>
                    </div>
                `).join('')}
            </div>
            <hr>
            <label>ì¼ì • ì œëª©</label><input id="calTitle" placeholder="ì¼ì • ì œëª©">
            <label>ì‹œê°„</label>
            <div style="display:flex; gap:10px; align-items:center;">
                <input id="calTime" type="time" value="09:00" style="flex:1;">
                <label style="margin:0;"><input type="checkbox" id="calAllDay"> í•˜ë£¨ì¢…ì¼</label>
            </div>
            <label>ì„¤ëª…</label><textarea id="calContent" placeholder="ìƒì„¸ ë‚´ìš©"></textarea>
            <div class="flex-align-center">
                <input type="checkbox" id="calRepeat"> <label for="calRepeat">ê¸°ê°„ ì„¤ì • (ë°˜ë³µ)</label>
            </div>
            <div id="repeatArea" style="display:none; margin-top:10px;">
                <label>ì‹œì‘ì¼</label><input type="date" id="calStartDate" value="${dateKey}">
                <label>ì¢…ë£Œì¼</label><input type="date" id="calEndDate" value="${dateKey}">
            </div>
            <div class="btn-row">
                <button onclick="saveCal('${dateKey}')">ì €ì¥</button>
                <button class="gray" onclick="navigate({page:'calendar'})">ì·¨ì†Œ</button>
            </div>
        </div>
    `;
    document.getElementById('calRepeat').onchange = (e) => { document.getElementById('repeatArea').style.display = e.target.checked ? 'block' : 'none'; };
    document.getElementById('calStartDate').value = dateKey;
    document.getElementById('calEndDate').value = dateKey;
}

function editCalEvent(date, id) {
    const ev = calendarData[date][id];
    editingCalId = id;
    document.getElementById('calTitle').value = ev.title;
    document.getElementById('calTime').value = ev.time;
    document.getElementById('calContent').value = ev.content;
    document.getElementById('calAllDay').checked = ev.isAllDay;
    if(ev.repeated) {
        document.getElementById('calRepeat').checked = true;
        document.getElementById('repeatArea').style.display = 'block';
        document.getElementById('calStartDate').value = ev.startDate;
        document.getElementById('calEndDate').value = ev.endDate;
    }
}

function deleteCal(date, id) {
    if(confirm("ì¼ì •ì„ ì‚­ì œí• ê¹Œìš”?")) {
        db.ref(`${BASE_PATH}calendar_v3/${date}/${id}`).remove();
    }
}

window.onpopstate = (e) => { if(e.state) { route = e.state; render(); } };
</script>
</body>
</html>
