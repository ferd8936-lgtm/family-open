<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
<title>ë˜‘ë˜‘!! ê°€ì¡± ê²Œì‹œíŒ</title>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

<style>
/* ì‚¬ìš©ìë‹˜ì˜ ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
@font-face { font-family: 'NexonLv2Gothic'; src: url('NexonLv2Gothic_2.ttf') format('truetype'); }
:root{--bg:#f8fafc;--card:#ffffff;--line:#e5e7eb;--brand:#6366f1;--ok:#16a34a;--bad:#dc2626;--wait:#d97706;}
*{box-sizing:border-box}
html, body { overscroll-behavior-y: none; height: 100%; }
body, button, input, textarea {margin:0; font-family:'NexonLv2Gothic', sans-serif; background:var(--bg);}
header{padding:20px 16px;text-align:center;background:#fff;border-bottom:1px solid var(--line);}
header h1 {margin:0; font-size:24px; font-weight:700; cursor: pointer; display: inline-block;}
header p {margin:8px 0 0; font-size:16.8px; color:#666; line-height: 1.4;}
main{max-width:1100px;margin:auto;padding:16px;}
body.full-view main { max-width: 100%; padding: 0; height: calc(100% - 60px); }
body.full-view header { border-bottom: none; }
.card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:16px;margin-bottom:16px;}
button, .sms-btn{display:block; width:100%; padding:9px 16px;border:none;border-radius:8px;background:var(--brand);color:#fff;font-weight:600;cursor:pointer;margin:6px 0; text-align:center; text-decoration:none; font-size:16px; font-family: inherit;}
button.gray, .sms-btn.gray{background:#e5e7eb;color:#111}
button.green{background:var(--ok)}
button.red{background:var(--bad)}
button.fit {width: auto; min-width: 80px; display: inline-block; margin: 0 8px 0 0; padding: 9px 20px;}
.btn-parent-input { width: auto !important; padding: 10px 30px !important; }
button.small{padding: 4px 10px; font-size: 13px; margin: 0;}
input, textarea {width:100%;padding:12px;border-radius:8px;border:1px solid var(--line);margin-top:6px;line-height:1.4;letter-spacing: -0.5px !important;font-size: 16px; color: #333;font-family: inherit; background: transparent;}
input:disabled, textarea:disabled { background: transparent; color: #333; border-color: #eee; }
input::placeholder, textarea::placeholder { color: #aaa; }
label{font-weight:600;margin-top:14px;display:flex; align-items: center; justify-content: space-between;}
textarea.purpose-box, textarea.plan-box { height: 100px !important; min-height: 100px !important; overflow-y: auto !important; resize: none; }
.top-actions {display:flex; gap:8px; margin-bottom:12px; justify-content: flex-start; align-items: center;}
.btn-submit, .btn-stats, .btn-cal {width: auto !important; margin: 0 !important; padding: 8px 18px !important;}
.btn-cal { margin-left: auto !important; background: #4b5563; }
.top-search {display: flex; gap: 8px; align-items: center; margin-bottom: 16px;}
.top-search input {margin-top: 0; height: 38px; flex: 1;}
.top-search button {height: 38px; margin: 0; min-width: 60px; width: 60px; padding: 0; white-space: nowrap;}
.table-wrapper {max-height: 540px;overflow-y: auto;border: 1px solid var(--line);border-radius: 8px;}
table{width:100%; border-collapse:collapse; position: relative; table-layout: fixed;}
thead th {position: sticky;top: 0;background: #fdfdfd;z-index: 10;border-bottom: 2px solid var(--line);}
th,td{padding:12px;border-bottom:1px solid var(--line);text-align:center;vertical-align:middle;}
tr.approval-row {cursor: pointer;-webkit-user-select: none;user-select: none;}
td.title{text-align:left; line-height:1.35; word-break: break-all;}
.badge{padding:6px 10px;border-radius:6px;color:#fff;font-size:13px;font-weight:700; white-space: nowrap;}
.ok{background:var(--ok)}.no{background:var(--bad)}.wait{background:var(--wait)}
.new-badge {background:#dc2626; color:#fff; font-size:10px; padding:2px 4px; border-radius:4px; margin-right:4px; vertical-align: middle; font-weight: bold;}
.parent-result{margin-top:12px;padding:12px;border-radius:8px;background:#f9fafb;border:1px solid var(--line); line-height: 1.6; margin-bottom: 10px;}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:16px;z-index: 1000;}
.modal .card{width:min(480px,100%); max-height: 85vh; overflow-y: auto;}
.btn-row {display: flex; gap: 10px; margin-top: 20px; justify-content: center;}
.btn-row button, .btn-row .sms-btn {flex: 1; margin: 0;}
.view-time-header {font-size: 14px;color: #666;margin-bottom: 10px;text-align: right;}
.cal-wrapper { background: #fff; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; touch-action: none; position: relative; width: 100%; }
.cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); grid-template-rows: auto repeat(6, 1fr); background: var(--line); gap: 1px; flex: 1; border-bottom: 1px solid var(--line); width: 100%; overflow: hidden; }
.cal-day-label { background: #fdfdfd; padding: 8px 0; text-align: center; font-size: 13px; font-weight: bold; }
.cal-day { background: #fff; padding: 4px; font-size: 13.2px; cursor: pointer; display: flex; flex-direction: column; gap: 4px; position: relative; overflow: hidden; font-family: 'NexonLv2Gothic', sans-serif; }
.cal-day-num-box { display: flex; align-items: center; gap: 4px; }
.cal-day.sun, .cal-day.holiday { color: red; }
.cal-day.sat { color: blue; }
.cal-day.other { color: #ccc !important; background: #fafafa; }
.cal-day.today { background: #fff; outline: 1px solid #000; outline-offset: -1px; z-index: 1; }
.holiday-text { font-size: 10.8px; font-weight: bold; line-height: 1; display: inline-block; font-family: 'NexonLv2Gothic', sans-serif; margin-left: 2px; white-space: nowrap; overflow: hidden; text-overflow: clip; max-width: 75%; }
.cal-event-container { display: flex; flex-direction: column; gap: 2px; width: 100%; overflow: hidden; flex: 1; }
.cal-event-item { color: #000; background-color: #eef2ff; padding: 1px 4px; border-radius: 2px; font-size: 10.8px; line-height: 1.1; width: 100%; display: block; overflow: hidden; word-break: break-all; white-space: normal; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; text-overflow: clip; }
.cal-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: #fff; border-bottom: 1px solid var(--line); flex-shrink: 0; }
.cal-header button { width: 34px !important; height: 34px; padding: 0 !important; font-size: 14px; }
.cal-footer { padding: 10px 15px; background: #fff; flex-shrink: 0; border-top: 1px solid var(--line); }
.stat-item {border: 1px solid var(--line); border-radius: 8px; padding: 15px; margin-bottom: 10px; line-height: 1.6;}
</style>
</head>
<body>
<header id="main-header">
    <h1 onclick="goHome()">ë˜‘ë˜‘!! ê°€ì¡± ê²Œì‹œíŒ</h1>
    <p id="header-desc">ì—„ë§ˆì™€ ì•„ë¹ ëŠ” ì–¸ì œë‚˜ ë„ˆì˜ ë©‹ì§„ ê³„íšì„ ì‘ì›í•´!</p>
</header>
<main id="app">ë°ì´í„° ë¡œë”© ì¤‘...</main>
<div id="pwModal" class="modal"></div>
<div id="statModal" class="modal"></div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const FAMILY_ID = urlParams.get('f') || 'default';

const firebaseConfig = {
  apiKey: "AIzaSyC4wyLWlZSDwNN8pqMSxiebB9z5CWrc93E",
  authDomain: "family-systems-4d19c.firebaseapp.com",
  databaseURL: "https://family-systems-4d19c-default-rtdb.firebaseio.com",
  projectId: "family-systems-4d19c",
  storageBucket: "family-systems-4d19c.firebasestorage.app",
  messagingSenderId: "670976286244",
  appId: "1:670976286244:web:84ae3450cbfc6823ec82b1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let PASSWORD = "7102"; 
let ENTRY_PASSWORD = "5677"; 
let familyConfig = {};
const BASE_PATH = `tenants/${FAMILY_ID}/`;

let route = { page: "list", id: null, date: null };
let keyword = "";
let allData = [];
let calendarData = {};
let currentCalDate = new Date();
let isAuthorized = localStorage.getItem(`auth_${FAMILY_ID}`) === "true"; 

const holidays = {
    "01-01": { name: "ì‹ ì •", red: true }, "03-01": { name: "ì‚¼ì¼ì ˆ", red: true }, "05-01": { name: "ê·¼ë¡œìì˜ë‚ ", red: false }, "05-05": { name: "ì–´ë¦°ì´ë‚ ", red: true }, "05-08": { name: "ì–´ë²„ì´ë‚ ", red: false }, "06-06": { name: "í˜„ì¶©ì¼", red: true }, "08-15": { name: "ê´‘ë³µì ˆ", red: true }, "10-01": { name: "êµ­êµ°ì˜ë‚ ", red: false }, "10-03": { name: "ê°œì²œì ˆ", red: true }, "10-09": { name: "í•œê¸€ë‚ ", red: true }, "12-25": { name: "ì„±íƒ„ì ˆ", red: true }
};

// [ë³´ì™„] ê°•ì œ ë¡œë”© ë¡œì§
let isInitialized = false;
db.ref(`${BASE_PATH}config`).on("value", (snap) => {
    const val = snap.val();
    if(val) {
        familyConfig = val;
        PASSWORD = String(val.masterPw || "7102"); 
        ENTRY_PASSWORD = String(val.entryPw || "5677");
        if(val.headerTitle) document.querySelector('h1').innerText = val.headerTitle;
        if(val.headerDesc) document.getElementById('header-desc').innerText = val.headerDesc;
    }
    if(!isInitialized) { isInitialized = true; init(); }
});

setTimeout(() => { if(!isInitialized) { isInitialized = true; init(); } }, 2000);

function init() { if(!isAuthorized) checkEntryPassword(); else render(); }

function checkEntryPassword() {
    const m = document.getElementById("pwModal");
    m.style.display = "flex";
    m.innerHTML = `<div class="card" style="text-align:center;"><b>[${FAMILY_ID}] ì ‘ì† ë¹„ë°€ë²ˆí˜¸</b><input id="entryPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸"><button onclick="verifyEntryPw()">í™•ì¸</button></div>`;
}

function verifyEntryPw() {
    const val = document.getElementById("entryPw").value;
    if(val === ENTRY_PASSWORD) {
        isAuthorized = true;
        localStorage.setItem(`auth_${FAMILY_ID}`, "true"); 
        document.getElementById("pwModal").style.display = "none";
        render();
    } else alert("ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜");
}

db.ref(`${BASE_PATH}approvals`).on("value", (snapshot) => {
  const val = snapshot.val();
  allData = val ? Object.keys(val).map(k => ({...val[k], dbId: k})) : [];
  if(isAuthorized && (route.page === "list" || route.page === "view")) render(); 
});

db.ref(`${BASE_PATH}calendar_v3`).on("value", (snapshot) => {
  calendarData = snapshot.val() || {};
  if(isAuthorized && (route.page === 'calendar')) render();
});

function navigate(p){ route = p; render(); }
function goHome() { navigate({page:'list'}); }

function render(){
  if(!isAuthorized) return;
  const app = document.getElementById("app");
  document.body.classList.remove("full-view");

  if(route.page === "list"){
    app.innerHTML = `
      <div class="top-actions">
        <button class="btn-submit" onclick="navigate({page:'new'})">ì˜ê²¬ ì˜¬ë¦¬ê¸°</button>
        <button class="btn-cal" onclick="navigate({page:'calendar'})">ìº˜ë¦°ë”</button>
      </div>
      <div class="table-wrapper">
        <table>
          <thead><tr><th>No</th><th>ì œëª©</th><th>ìƒíƒœ</th></tr></thead>
          <tbody>
            ${allData.map((r,i)=>`<tr onclick="navigate({page:'view', id:'${r.id}'})"><td>${i+1}</td><td>${esc(r.title)}</td><td>${badge(getStatus(r))}</td></tr>`).join("")}
          </tbody>
        </table>
      </div>`;
  } 
  else if(route.page === "calendar"){ 
    document.body.classList.add("full-view"); 
    renderCalendarView(app); 
  }
}

// ìº˜ë¦°ë”ë¥¼ ì‹¤ì œë¡œ ê·¸ë¦¬ëŠ” í•¨ìˆ˜ (ì´ê²Œ ê¼­ ìˆì–´ì•¼ í•©ë‹ˆë‹¤)
function renderCalendarView(container) {
    const year = currentCalDate.getFullYear(); const month = currentCalDate.getMonth();
    container.innerHTML = `
        <div class="cal-wrapper">
            <div class="cal-header">
                <button onclick="changeMonth(-1)">â—€</button>
                <b>${year}ë…„ ${month + 1}ì›”</b>
                <button onclick="changeMonth(1)">â–¶</button>
                <button onclick="goHome()">ğŸ </button>
            </div>
            <div class="cal-grid">
                ${['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].map(d => `<div class="cal-day-label">${d}</div>`).join('')}
                ${getCalendarDays(year, month)}
            </div>
        </div>
    `;
}

function getCalendarDays(year, month) {
    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month + 1, 0).getDate();
    let days = [];
    for (let i = 0; i < firstDay; i++) days.push('<div class="cal-day other"></div>');
    for (let i = 1; i <= lastDate; i++) days.push(renderDay(year, month, i));
    return days.join('');
}

function renderDay(y, m, d) {
    const dateKey = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const events = calendarData[dateKey] || {};
    return `<div class="cal-day"><span>${d}</span><div>${Object.keys(events).map(id => `<div class="cal-event-item">${esc(events[id].title)}</div>`).join('')}</div></div>`;
}

function changeMonth(diff) { currentCalDate.setMonth(currentCalDate.getMonth() + diff); render(); }
function getStatus(r){ return (r.mom === "approve" && r.dad === "approve") ? "ì°¬ì„±" : "ëŒ€ê¸°"; }
function badge(s){ return `<span class="badge ${s==='ì°¬ì„±'?'ok':'wait'}">${s}</span>`; }
function esc(s){ return String(s??"").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
</script>
</body>
</html>
